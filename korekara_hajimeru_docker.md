# これから始めるDocker
- WEB+DB vol.98 2017

# Dockerとは    
- インフラをコード化するもの
    - version管理
    - 自動セットアップが楽    

## vagrant/Chefとの違いは
- 仮想サーバーそのものを管理する手間はかかる
- 環境が増えると大変
- 環境によってアプリケーションが動く、動かない問題
- １つのサーバー上に複数のコンテナを立ち上げられる
    - 仮想サーバーと同じように見えるかもしれないが、Dockerの場合はあくまでもプロセスやファイルシステム、ネットワークが独立して見えるだけ

## Dockerに対応した開発環境とインフラ構築
- Dockerが担うのは開発・デプロイ・実行を簡単にするためのプラットフォームとしての役割

### ローカル開発環境
- Vagrantのような仮想化技術を開発環境として使う場合はリソースの割当てや起動のために数十秒以上の時間が必要
- Dockerはコンテナを数秒で建てられる

### Dockerイメージの自動構築とデプロイ
- 仮想マシンのみのインフラ環境が前提であれば、ローカルの仮想マシンイメージをリモートのクラウド環境上に直接移動することは現実的とは言えない
    - 自動せってアップのためには予めマシンイメージを準備しておいたり、構成管理ツールをセットアップしたりすることは欠かせないのでコストの方が大きい
- Dockerイメージであれば、仮想マシンイメージよりも使用するディスク容量が小さい
- Dockerイメージは親子関係を持つイメージレイヤの積み重ねにより構成されている
    - キャッシュを利用した高速な環境構築ができる
    - イメージ差分情報のみをリモート環境に送ることができる

### 導入時の課題と検討事項
- コマンドに慣れる必要がある
- コンテナごとに性能測定を行いたい場合や、より厳密なリソース監視を行いたい場合、既存のツールで対応できない可能性がある

# 2章: Dockerを使ったアプリケーション開発
## Docker環境をローカルに準備
Dockerを使い、Dockerコンテナを実行できるようにするには、DockerEngineをセットアップする(方法は以下３つ)
- Linuxにセットアップ
    - 各ディストリビューションに対応したDockerEngineのバイナリをセットアップする
- 仮想サーバー上にDockerをセットアップ
    - DockerMachineを使い、VirtualBoxやクラウドのAPIを通し、DOckerEngineが動くホストをセットアップする
- Docker for Mac/Windowsをセットアップ
    - VirtualBoxやVagrantではなく、ローカルPC上の仮想化技術を用い、コマンドライン上でDockerを使えるようにする

## Dockerコンテナの基本操作
- Dockerコンテナの実行には、実行に必要なファイルや設定情報を含むDockerイメージが必要
    - DockerイメージはDockerHubを通して配布されている

### Apache(httpd)イメージのダウンロード
- 仮想サーバーのディスクイメージとDockerイメージは、どちらも「イメージ」と呼ばれるが、概念が異なる
    - ディスクイメージ: 仮想的なハードディスク=>一般的にファイル容量が大きい
    - Dockerイメージ: コンテナ実行時に必要となるファイルのみで、実体を構成するディレクトリ内の容量は少なめ
        - イメージレイヤは複数のイメージやコンテナで共有できるため、仮想サーバーに比べてシステム全体のディスク使用量を抑えられる利点がある
- Apacheがインストール済みのイメージを取得
    - docker pull httpd
    - docker image list で確認できる

### コンテナとして実行
- Dockerを使わずに通常通りApacheを起動した場合、ホスト上のすべてのファイルにアクセスでき、任意のポートを開ける
- Dockerコンテナとして起動する場合はDockerイメージ内しかアクセスできず、イメージ内にあるhttpdのバイナリを起動する
    - コンテナとして起動したプロセスはホスト上に存在するが、コンテナ同士はプロセス空間、ファイルシステム階層、ネットワーク、UID/GIDを分離された状態になる
- 通常、複数のApacheを起動しようとしても、ポート番号が重複してエラーになる
    - コンテナとして実行した場合はコンテナ内とホスト側でネットワークが別れているので、エラーにならない
- Dockerコンテナの実行にはdocker runコマンドを使う

### イメージの作成と削除
- 既存のコンテナへの変更をもとに新しいイメージを作成できる
    - docker image commit
        - 実行中のDockerコンテナ用レイヤをもとに新しくイメージを作成する
    - docker build
        - 自動構築用コマンド。作成手順をすべてDokerfileに記述できる
- イメージ名、タグを割り当てられる

## アプリケーションの開発用途として活用
### ボリュームの活用
- Dockerは動的に変化するデータの保持に向いていない
    - 動的なデータを扱うには、ホスト側にデータ保存用の特別なディレクトリを作成するボリューム機能を使う
- ボリューム機能とは、コンテナのイメージレイヤとは別にデータを管理する仕組み
    - Dockerホスト上のディスク領域をネイティブに読み書きできる
    - 複数のコンテナでデータを共有したい場合に便利
    - ボリュームの実体はホスト上の /var/lib/docker/volumes ディレクトリ内

# 3章: VPS/クラウドでのDocker環境の整備
## VPSとクラウドサービスの違い
### VPS
- 価格が安く、シンプル
- root権限も使える

### クラウド
- 大きなシステムを構築できる
- サーバーの負荷に応じてスケーリングできる

# 4章: 本番環境でのアプリケーションの立ち上げ
## ワークフローの中心にあるDockerHub
Dockerが目指しているのはアプリケーションをどこでも実行できるようにするプラットフォームを提供すること
- 簡単にBuild, Ship, Runすること
- イメージを自分でDockerHubにアップすれば、それは可能

## イメージ/コンテナのライフサイクル
Dockerイメージは読み込み専用のイメージレイヤの積み重ねで構成されている
- 概念としては、親子関係を持つ複数のレイヤが透過的に重なり、１つのファイルシステムを形成している

# 5章: 
