# ブロックチェーン
## ブロックチェーンの存在理由
- ビットコインのブロックチェーンに格納されている内容は世界中で発生したトランザクション
    - それだけならP2Pで全サーバーのDBに格納し続けるだけで良い

#### ブロックが必要だった理由は、ブロックを対象とする処理を調べてみればわかる
- 不正を含まない台帳記録としてコンセンサスを確定する処理
- プルーフ・オブ・ワークの付与によって記録の非可逆性を保証する処理
- 分岐(フォーク)が可能な時系列的記録の中で、ベストなものをマイニングゲームによって選択する処理

### コンセンサス処理の最適化方法としてのブロック
ブロックサイズの最適値は以下の要素の複雑な関係を持つ
- ブロックを生成する時間感覚
- トランザクションの発生頻度
- P2Pネットワークに参加するノード数
- ネットワークのレイテンシやスループット

### コンセンサスの表現(representation)としてのブロック
- ビットコインのコンセンサスは創発的コンセンサスと呼ばれる

### ブロックチェーーのソフトフォークとハードフォーク
- 全世界の全てのビットコイン利用者やマイナーのプログラムコードを一斉にバージョンアップすることは現実的に不可能
- ソフトフォークは古いブロックの仕様と互換性のある仕様の修正
- ハードフォークは古いバージョンのノードから見れば不正なブロックんい見えてしまう大きな仕様の変更

## ブロックの構造
|サイズ|フィールド名|説明|
|4バイト|Block Size|ブロックのデータサイズ(バイト)|
|80バイト|Block Header|ブロックヘッダ|
|1~9バイト|Transaction Counter|ブロックに含まれるトランザクション数|
|可変長|Transactions|ブロックに含まれるトランザクションのリスト|

### ブロックの識別子
ブロックを参照するためのブロックの識別子には
- ブロックハッシュ
- ブロック高

bitcoin-cliのgetchaintipsコマンドを使うと、現在のブロックチェーンの先端がわかる

### ブロックヘッダの構造
- ブロックに含まれるトランザクションはマークル木を使ったハッシュチェーンとしてまとめ上げられる
- その構造の根にあたるマークルルートがブロックヘッダのMerkle root hashフィールドに埋め込まれて居る

### マークル木
ブロックヘッダにそのブロックに含まれる全トランザクションをまとめあげたマークルルートが埋め込まれていることでそこに含まれる任意のトランザクションが実際にブロックに含まれて居ることを効率的に証明できる

- ビットコインのノードの中にはブロックチェーンの全データではなく、ヘッダ情報だけを持つノードもある
    - SPV(Simple Payment Verification)ノードと呼ぶ
    - スマホのウォレットのほとんどはSPVノード

### ブロックサイズ
- 処理効率の最適化の観点だけから見ると理論的に最適なブロックサイズが定まる
    - 2018年3月現在で1ブロックサイズの上限が1メガバイト
    - 明らかにブロックサイズが足りていないが、理論的な最適値が求められていない
- 常時稼働してるフルノード数は約7000

## マイニング
- プルーフオブワーク法を用いている
    - 1997年に発明されたHashcashアルゴリズムを利用
- 暗号学的ハッシュ関数をnonceをシードとする擬似乱数生成装置とみなし、そのハッシュ値がある難易度ターゲットよりも小さい数値となるようなnonceを求める計算

### ビットコインの通貨単位
- マイナーが通貨発行者と思われがちだが違う
    - バランスシートの視点で見れば、無から一定の貨幣的価値が生じたような状況が存在している

### マイニング処理
- Nonceフィールドの値を順次変更しながらブロックヘッダのSHA-256によるハッシュ値の計算を求める
    - そのハッシュ値がブロックヘッダのDifficulty Targetフィールドで定められた難易度ターゲットよりも小さい数値であれば成功

#### プルーフオブワークの実際の値
- Nonceフィールドは4byte = 43億通りしかない
- 現在はextraNonce = コインベースのインプット領域 を8バイト追加して12バイトあることにして対応している 

#### コインベーストランザクションを得る

### マイニングの難易度
- nonceを書き換えながらSHA256ダブルハッシュを求め、ハッシュ値が目標値より小さくなれば成功
    - 当然、この数値が小さくなれば難易度が上がる

#### difficultyの表現
- ブロックヘッダのDifficultyTargetがマイニングの難易度の目標値になる
- difficulty bits か bits と呼ばれる

#### マイニング難易度の決定法
- 10分間隔でのマイニングを持続するためにはマイナーたちの計算能力に応じてdifficultyの調整が必要
- 難易度調整は2016ブロックごと（2週間)に行われる
    - retargeting

### マイニング報酬
マイナーは自分が作成したブロックにコインベーストランザクションを追加できる
- ビットコイン経済圏における通貨発行
- マイナーへの報酬
- 4年ごとに半減期を迎える
    - 現在12.5BTC

### マイニングプール
小規模マイナーがマイニングに成功する確率は1~2年に1回

#### プールマイニング
複数のマイナーが協力してマイニングを行うことで投資のリスクを分散できる  
マイニングプールのシェア分布は以下
- 1: AntPool   15.9%
- 2: BTC.TOP   11.9%
- 3: Bixin      9.9%
- 4: F2Pool     9.9%
- 5: BTCC Pool  8.5%
- そのほか     43.9%

#### マイニングプールにおける報酬の分配法
##### Pay-per-share
提供したハッシュパワーに応じて支払う方式(マイニングが成功しなくても支払われるのがポイント)
- プールオペレータが実際のマイニング難易度の1/1000程度難易度設定
- プールマイナーはその難易度以上のハッシュ値を得るたびにプールオペレータにそれを提示
- プールマイナーはその一覧を作成して全プールマイナーに公開し自分のマイニングプール内でのハッシュレートのシェアを知る
- プールオペレータが比率に応じて分配

プールオペレータのリスクが大きいので、マイニングプールの利用料は割高になる

以下の課題がある
- プールマイナーが本当にマイニングに成功した場合にそのハッシュ値をマイニングプールに送らずに自分の収入にしてしまう可能性
- 自分のプールでマイニングに届かなかったハッシュ値を他のマイニングプールに送りつけ、他のマイニングプールから報酬だけを奪う可能性

##### プロポーショナルモデル
基準以上のハッシュ値を示すだけでは報酬をもらえない  
実際にマイニングに成功したときのみ、マイニングプール内のハッシュパワー比率に基づいて報酬が分配される  
ハッシュパワー算定の方法はPay-per-shareと同じ  
プールオペレータのリスクを軽減するので、マイニングプールの利用料は一般に小さめになる

#### プールマイニングAPI
プールサーバのプールオペレータは新規ブロックの作成作業を行う
- 直前のブロックヘッダのブロックIDを定め、それに続くブロックヘッダを作成
    - 自分のコインベーストランザクション
    - ブロックに取り込むトランザクションの集合を決定

この時点ではマイニングのためのnonce領域, extraNonce領域, mercleRoot領域が定まっていない  
マイナーがマイニングを行うには上記の値からブロックヘッダのハッシュ値を求めることができなければならない  
そのために必要な情報を配信するStatumやGetBlockTemplateというAPIが存在する

#### プールマイニングとソフトフォークの投票権
情報はBIP0009でブロックのバージョンビットのセマンティクストして表現されている

#### getblocktemplateAPI
マイニングのためのブロックテンプレートの詳細な情報を入手できる

### マイニングプールの問題点
巨大なマイニングプールが出現したら、強大な力を持ってしまうこと
- マイニングに成功したブロックをブロードキャストせずに即材に次のブロックのマイニングを開始し、他のマイナーの努力を無駄にさせる利己的マイニング
    - 30％程度のシェアで実現が可能

## ブロックチェーンからの情報収拾
ブロックの内容はブロック高 or ブロックインデックスから全て確認可能  
BitcoinCoreは2つのDBを使用している
- Berkeley DB
    - ウォレット実装
- Level DB
    - ブロックチェーン実装

### 仮想通貨流通経路の追跡

### 仮想通貨流通速度の測定

