# ビットコインとブロックチェーンの基本
## ビットコインネットワーク
- Bitcoin Coreなどを実行すると、自動的にビットコイン・ネットワークい接続される
- ビットコインネットワークに接続されているコンピュータはどれも全て対等で特別なものは一つもない
- P2Pシステムではどのコンピュータもサーバーでありクライアントなので、ノードと呼ばれる

## ブロックチェーンの同期
- ビットコインのソフトを稼働させるとまず空のブロックチェーンのデータを格納するデータベースができる
- 自分のノードのブロックチェーンの内容がビットコイン・ネットワークの他のノードと同じになるまで続く
    - ブロックチェーンの同期と呼ぶ
    - ブロックチェーンのデータサイズは2017年6月の段階で120GBを超えている
    - ブロックチェーンの同期が完了するにはかなりの時間が必要
- ブロックチェーンの同期が完了するとそのノードは他のノードへの情報提供側としても振る舞うようになる

## 電子マネーの理想像を実現したビットコイン
- ビットコインはソフトウェアだけでできた電子マネー
- 約20年もの間実現不可能と思われていた電子マネーの理想像をほ完全に実現し歌技術
- 電子マネーの最大の難問は、現物の紙幣やコインと違って二重使用できてしまうところ
    - 実用的に解決するにはICカードのような特別なハードウェアや信頼できるサーバが必要とされてきた
    - しかしビットコインは参加者全員による台帳記録の検査という方法で解決した

## 分散台帳としてのブロックチェーン
- ビットコインの開発は2009年にスタートされ、それ以来世界で起きたすべてのビットコインによる取引の記録がのこっている
- ブロックチェーンの記録を調べれば全ての取引の整合性を確認できる
- ブロックチェーンの本質は世界中で稼働しているビットコインネットワークのノードを使って台帳記録の整合性を検証して保管するシステム
    - よって、台帳記録の正しさを保証するために銀行や政府のような第三者が必要ない

## トランザクションのブロードキャストによる送金
- 台帳に記録されるデータの最小単位がトランザクション
- ブロードキャストとは
    - ビットコインを送金するとき、送金者はまずデータ構造としてのトランザクションを作成する
    - 送信先は、送金先だけでなく、ビットコイン。ネットワークにえsつ属されている全てのノード
- ブロードキャストされたトランザクションはそれを受け取ったノードでの内容の整合性の検証を受ける
    - 内容に不整合があれば、他のノードへの階層は行われずすてられる
    - 検証に成功したトランザクションが最終的にブロックチェーンに取り込まれることによって正当な台帳記録として定着する
- ビットコインの送金先はビットコインアドレスというアドレスで識別される
    - 26 ~ 35文字の数字とアルファベットの文字列

## ビットコインのトランザクションと通貨価値の総量保存則
- ビットコインのトランザクションのデータ構造はインプととアウトプットという二つの領域からできている
- インプットもアウトプットも複数存在できるが、簿記と同じ要領で、総額はおなじになっていなければならない
- 上記の法則が保証されるために、会計監査が必要
    - この監査は全員で分担している

### トランザクションの時制式三式簿記構造
- ブロックチェーンの中のトランザクションのアウトプットには、未使用状態と使用済み状態の二つの状態がある
    - 未使用状態のアウトプットをUTXO(Unspent Trasnsaction Output)と呼ぶ
    - 使用済みのアウトプットはそれを使用した次のトランザクションのインプットから参照されることによって接続関係をもっている
- このトランザクションのインプット、アウトプット、UTXOを使った台帳記述法を用いると過去、現在、未来に渡って貨幣的価値を増減していないことを検証できる

### トランザクションの手数料
- ブロックの作成者であるマイナーは必ずしも全てのトランザクションをブロックに取り込むわけではない
- 送金者はマイナーに対して自分のトランザクションを優先的にブロックに取り込んでもらうために手数料を支払う必要がある
    - インプットの総額とアウトプットの総額の差額がマイナーへの手数料になる
- マイナーの収入はコインベースのアウトプットの金額に自分が作成したブロックの中に含まれている全トランザクションの手数料の合計が加わる
    - サトシ・ナカモトのオリジナルの設計では約4年ごとにコインベースによるマイナーの収入は半減していき、ついには0になってしまう
    - その代わりに手数料による収入の方がマイニングのインセンティブになっていくことが想定されている
    - 以前は手数料なしのトランザクションも許容されていたが、現在は不可能
- Bitcoin Core 0.12.0以降のトランザクション手数料に関するパラメータのデフォルト値は以下のように設定されている(一般的なトランザクションのサイズは500bytes)
    - txconfirmtarget: 2(blocks): 手数料を可変にする場合に参考にする直前のブロック数
    - paytxfee: 0(BTC/kB): 手数料を固定にする場合に設定。0は手数料を可変にするという意味
    - fallbackfee: 0.0002(BTC/kB): 見積もりに失敗した場合のデフォルト手数料
    - maxtxfee: 0.1BTC: 手数料の上限、設定値以上の手数料は認められない
- マイナーは自分が受け取ったトランザクションをメモリープールという領域に保管
    - マイニングが成功すると、メモリープールの中のトランザクションをブロックに格納していく
    - 全てのトランザクションを取り込むわけではなく、取り込まれなかったトランザクションはメモリプールに残され、取り込まれるのを待つ
- サトシ・ナカモトが作成した原案の仕様では、ブロックサイズの上限は36Mbytesで徐々に拡張することになっていた
    - DoS攻撃の対策のために最大ブロックサイズが1Mbytesに減らされ、固定となった

### 非可逆的記録としてのブロックチェーン
- 一旦記録されると書き換えが不可能
- 以下2つの技術によって実現されている
    - ハッシュチェーン
    - マイニング

### ハッシュチェーンとしてのブロックチェーン
- ハッシュチェーンは暗号学的ハッシュ関数という暗号技術を利用している
- ハッシュチェーンはデータのハッシュ値を次のデータに埋め込むことで一連のデータを鎖のように連接させたもの
- ブロックチェーンはハッシュチェーンである
    - ブロックと呼ばれるデータが時系列的に繋がれたデータ
    - 1ブロックの中には平均10分間に全世界で発生した数百から数千程度のトランザクションが格納されている
    - ブロックチェーンの中に接続されているブロックはハッシュチェーンによって追加や欠落や順序の入れ替えができないように接続関係が固定されている
- ブロックチェーンの各ブロックには、一連のブロックチェーンの中の順序を表すブロック高という値が入っている
    - ブロックチェーンの最初のブロック、つまりブロック高が0のブロックは世界の始まりを意味するジェネシス・ブロックと呼ばれる

### マイニングを利用したブロックチェーンの記録の非可逆性
- マイニング計算によって得られる計算結果をプルーフ・オブ・ワークと呼ぶ
- ブロックを作成できるのは世界中のビットコイン・ネットワークのノードの中でただ1つのノードだけ
- ハッシュチェーンとしてのブロックチェーンの各ブロックには、それを作成したマイナーによって計算競争にしょうりした証となるプルーフ・オブ・ワークが含まれている
- マイニング計算競争の難易度は2016ブロックごとに平均時間が算出され、新しいブロックが作成されるのに必要な時間が平均10分となるように自律的に調査れるようになっている
    - 2016\*10 は14日にあたる
- ブロックチェーンの書き換え
    - ブロックに含まれるプルーフ・オブ・ワークも再計算しなければならない
    - 計算競争に参加している全てのマイナーを圧倒的に上回る計算能力が必要になる
    - 事実上不可能であることが改竄の可能性を消している

### 新規ブロックの作成とビットコインの通貨発行
- マイニングは仮想通貨としてのビットコインの通貨発行の方法
    - ビットコインの通貨発行は中央銀行のよう主体が行うのではない
    - 計算競争に勝利したマイナーが10分ごとに1つのブロックを生成するたびに一定額のビットコインを発行し、これがマイナーの報酬となる
- マイナーが作成する新しいブロックには、コインベースと呼ばれる通貨発行用の特別なトランザクションが一つだけ含まれている
    - これが計算競争に勝った特権
- 当初は50BTCだったが、210000ブロック(4年)ごとに半減していく(現在12.5BTC)

### ブロックの検証とブロックチェーンへの接続
- 計算競争に勝利したマイナーが作成した新しいブロックはビットコイン・ネットワーク全体にブロードキャストされる
- 新しく生成されたブロックをそれまでのブロックチェーンに接続するのは作成したマイナーではなく、一般のノードである
    - ビットコイン・ネットワークにブロードキャストされたブロックは各ノードがそれぞれその内容を検証し、完全に問題がない場合に限って自分のノード内のブロックチェーンに接続する
    - 新しいブロックがビットコイン・ネットワークの全てのノードにおいてブロックチェーンに接続されると、ブロックの中に含まれている全トランザクションも非可逆的な記録として定着する
- ブロックの中に会計監査に合格していない不正なトランザクションが一つでもあれば、そのブロックはブロックチェーンに接続されずに捨てられる
    - その場合は計算競争を行なっている他のマイナーの誰かが作成したブロックが正当なものとなってしまう

## 公開鍵暗号の電子証明を利用した電子通貨の使用
- ビットコインウォレットをインストールして起動すると最初にその人の秘密鍵と公開鍵が生成されてウォレットに登録される
- ビットコインの送金先となるビットコインアドレスはその人の公開鍵から生成される
    - ビットコインの送金先はトランザクションのアウトプットに記録される
    - そのアウトプットが未使用の時、そのビットコインアドレスを持つ受領者の所持金を意味するUTXOになる
- ビットコインのUTXOはロック状態ではしようできない
    - アンロックには電子証明を利用する
    - 電子証明はその作成者と公開鍵と対象メッセージを使った計算によって正当なものかどうかを検証することができる
- 自分の所持金であるUTXOを誰かに送金しようとする送金者は自分の秘密鍵を使って電子署名を行うことによってUTXOをアンロックする
    - その際に自分のビットコインアドレスに対応する公開鍵をトランザクション内部に記述することによって第三者が自分の電子署名の正当性を検証できる

## ブロックチェーンの記録の正当性とコンセンサス
- ブロックチェーンは1つの一貫した出来事の歴史を記録することを目的とするクロニクル(時系列的記録)だが、問題はある
    - ビットコインの経済圏における出来事は地球規模の巨大な分散システムで予告なしに発生している
    - 出来事を観測する場所によって相対的に歴史が分岐してしまうことがある
    - それらを台帳として記録し管理するブロックチェーンのノードは身元を明らかにしていない人々で運営されている
    - ノードの中には不正な行為を行うものや故障しているものがあるかもしれない

### レイテンシによるブロックチェーンの分岐
- ブロードキャストが隣接ノードを蹴り湯しながら連鎖的に行われるので、隅々まで伝播が完了するには大きなレイテンシが存在する
- マイナーも世界に点在しているので、ブロードキャストされたトランザクションを受け取る順序はマイナーの地理的な場所によっても異なる
- マイナーから見たブロックチェーンのクロニクルは整合的
- どの枝の歴史もそれぞれ整合的なものだとすると、どれを正統な歴史として選ぶかということが問題になる
    - ビットコインのコンセンサス・アルゴリズムでは最も長い枝が正統なブロックチェーンであるというルールになっている

### 意図的なブロックチェーンの分岐
- マイナーが二つの競合するトランザクションを作成し、分岐したブロックチェーンにそれぞれのトランザクションを取り込んだ場合
    - マイナーが意図的に作成したチェーンを最長となるまで伸ばして正統なチェーンとしたときに、マイナーによって歴史の操作が可能
- UTXOの二重使用の典型的な例は送金者がマイナー自身か、あるいはマイナーと結託している場合
    1. 送金者による商店への支払いを意味するトランザクションをブロードキャストし、そのトランザクションがブロックに取り込まれたことを確認した商店が商品を発送
    1. マイナーでもあるその送金者は、商品を受け取った後にその支払いを使ったUTXOを自分自身に送金するという別のトランザクションを作り、商店への支払いトランザクションが含まれるブロックの直前のブロックに後続するブロックに組み込んでブロードキャストする
    1. さらにそのマイナーがそのブロックに後続するブロックを作成し続けて、世界中のノードがそれを正統なチェーンと認めた場合、二重使用が成功する

### 最長のブロックチェーンが正統なブロックチェーン
- マイナーによるこのような攻撃が可能になるのは、競争相手のマイナーたち全員を上回る計算能力を得たときに限る

### コンセンサス・アルゴリズム
- 前提条件次第でコンセンサスを取る難易度が違う
- 故障や裏切り者が存在するような分散システムにおいて、合意形成アルゴリズを求める問題は難問とされている
    - ビザンティン合意問題
    - FLP不可能性

### プルーフ・オブ・ワーク法
- マイナー達の欲望に基づく計算競争を利用したコンセンサス・アルゴリズム
    - マイナーへの仮想通貨採掘報酬へのインセンティブがポイント
    - 人間の経済的欲望に基づくゲーム論的な行動の選択が巧みに組み込まれている
        - 莫大なコストをかけて運用しているマイナーたちが、その価値を毀損するような行為をするのは合理的でない

### 創発的なコンセンサス
- 技術的躍進の本質
    - 非常に多く違いに関係を持たない参加者達による独立した活動によって、コンセンサスが創発的に形成されていくこと
    - 上記により政府や大企業などのような集権的な「信頼できる」主体を必要としない電子通貨となった

### トランザクションの確認数
トランザクションはブロックに取り込まれ、そのブロックがブロックチェーンに接続されて初めて確認されたことになる  
- しかし、これだけではまだそのトランザクションがブロックチェーンに定着したとは言えない
- ブロックチェーンは分岐して他の枝が正統なものになる可能性がある
- ブロックに取り込まれてから現在の最新のブロックが接続するまでに何このブロックが存在して炒るかという数のことを確認数と呼ぶ
    - 確認数が増えるにつれてそのトランザクションの非可逆生が高まる
    - 非可逆である確認数の目安として、確認数6がよく使われる
        - トランザクションが非可逆であることを保証するまでに60分かかることを意味する



































