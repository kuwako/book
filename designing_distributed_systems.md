# 分散システムデザインパターン

# 第一部: シングルノードパターン
関心事を分離するために、仮にシングルノードであったとしても、コンテナを分離させるメリットがある

## 2章: サイドカー
サイドカーパターンは１台のマシン上で動く２つのコンテナから構成される
1. アプリケーションコンテナ
    - アプリケーションのコアロジック
1. サイドカーコンテナ
    - アプリケーションを拡張したり改善したりする
    - ディスクやネットワークなどのリソースをアプリケーションコンテナと共有する

### 2.1 サイドカーの例: レガシーサビスのHTTPS対応
1. レガシーサービスをlocalhostからしかアクセスできないようにする  
1. nginxのサイドカーコンテナを配置する
    - nginxが外部IPからのHTTPSトラフィックを受け取りレガシーサービスに受け流す

### 2.4 gitワークフローを利用したサイドカー
- アプリケーションコンテナ
    - Webサーバが実装されたNode.jsサーバ
- サイドカーコンテナ
    - アプリケーションコンテナとファイルシステムを共有し、ファイルシステムをGitリポジトリと同期するためのループを実行

新しいコードがGitリポジトリにPushされるたびに自動的にロードされる仕組みが簡単にできる

### 2.5 モジュール化と再利用性を考えたサイドカーの設計
#### 2.5.1 パラメータ化されたコンテナ
例えば2.1のnginxのサイドカーの場合、少なくともSSLを利用するための証明書のパスとローカルホストで動いているレガシーアプリケーションのポート番号の２つが必須
- 環境変数か、コマンドライン引数で渡す必要がある
- パラメータ化することで、コンテナは実行するたびに呼び出される関数のように扱える

### 2.6 まとめ
- サイドカーパターンではサイドカーコンテナがアプリケーションコンテナを増強し、拡張する
- サイドカーは、アプリケーションに変更を加えるにはコストが高すぎる際にレガシーアプリケーションを更新するために利用できる

## 3章: アンバサダ
アンバサダコンテナがアプリケーションコンテナとそれ以外の間のやり取りを仲介する仕組み
- モジュール化されて再利用可能なコンテナを作れる
- 色々なアプリケーションコンテナと組み合わせが可能

### 3.1 サービスのシャーディングへのアンバサダの利用
一つのバックエンドストレージしか想定していない既存コードにシャーディングクライアントを組み込むのは難しい
- アンバサダコンテナにシャーディングのロジックを持つことで関心ごとの分離ができる

### 3.3 システムの実験的運用やリクエスト分割への利用
- アプリケーション側に細工をせずに10%のリクエストだけ実験用のシステムに送る

## 4章: アダプタ
- 他のアプリリプケーションが期待する定義済みのインターフェイスのルールを守ったままアプリケーションコンテナのインターフェイスを変える

### 4.1 監視
- アダプタコンテナがアプリケーションコンテナが公開している監視インターフェイスを汎用的な監視システムが使うインターフェイスに変換する
- 監視アダプタを別コンテナとしてデプロイすると、CPUやメモリのようなリソースが別々で割り当てられるので監視アダプタが不正な動きをしてもユーザー向けのサービスに影響を及ぼさないようにできる

### 4.2 ロギング
- fluentdをアダプタコンテナとしてredisのslow-queryをデバッグする
