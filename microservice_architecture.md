# マイクロサービスアーキテクチャ(オライリー)
# 1章: マイクロサービス
## メリット
- 各サービスで違った技術を採用でき、それぞれでデプロイできる
- 回復性が高い
- スケーリングが容易

## デメリット
- オーバーヘッドが大きい
- 小さいサービスには向いていない
- 必要なリソースが増える

# 2章 進化的アーキテクト
- マイクロサービスアーキテクチャでは、予測が困難な状況の下で多くのトレードオフな判断が必要になる
    - 目標と、それを実現するための原則とプラクティスを定めることで対処する

# 3章 サービスのモデル化方法
- 独立してデプロイできる疎結合性と、ドメインの境界づけられたコンテキストでまとめられた高凝縮性が必要
- 経験のないドメインを扱う場合は最初はモノリスで作って、ドメインの理解が進んでからマイクロサービスに分離していくと良い
- コンテキスト境界を分離する際には、データで切るのではなく、コンテキストが外部に公開する振る舞い(ドメイン)に注目する
- DBは必ず分割すること

# 4章 統合
- APIを技術に依存させないようにする
- 共有DBは強い凝縮性と疎結合の両方を失うので避けるべき。絶対に避けるべき。
- RESTとRPCとの間のトレードオフを理解し、RESTをリクエスト/レスポンス結合の優れた出発点であると認める
- ユーザーインターフェースを合成レイヤーと捉える

# 5章 モノリスの分割
- モノリスを分割するには、少しずつ切り崩すのが良さそう
- 実践の中でマイクロサービスを学ぶため(どうせ最初はうまくいかないだろう)
- 外部キー関係の削除(整合性を保証できなくなる)
- 共有静的データ(国コードなど)
    - 列挙型でコードとして管理するのが結局おすすめ
- 共有データ(顧客データなど)
    - それはもうドメインでは、ということに注目し顧客サービスを作る
- まずはDBから分割し、その後アプリケーション側を分割してマイクロサービスにする
- トランザクション境界
    - あとでリトライ(結果整合性)
    - 操作全体の中止が必要な場合が出てくるが、打ち消しようのdelete文すら失敗の可能性があり、不安定
    - 例えば、処理中の注文という概念を考え出す必要がある
- レポートなどが必要な場合、必要な情報をバッチ的にまとめて取得するAPIを設けないと死ぬ
- データポンプ
    - httpのオーバーヘッドが大きいので、レポート用に定期的にデータを送るシステムを採用するのもあり

# 6章 デプロイ
- サービスごとにデプロイできるよう、ツール等も自由にやって良い
- 環境のデプロイもコード化すると良い

# 7章 テスト
- マイクロサービスの利点を得るには、テストを自動化してサービスを迅速かつ効率的に検証できるようにすることが不可欠
- テストをステージに分け、適切かつ高速にフィードバックループが回るようにする

# 8章 監視
- マイクロサービスでは監視する対象が急激に増えるので、統合的に見れる環境を作る
- 誰でも閲覧できる状況にする

# 9章 セキュリティ
- 複数のサービスでユーザを認証・認可するためにシングルサインオンの仕組みが必要

# 10章 コンウェイの法則とシステム設計
- システムを設計するあらゆる組織は、必ずその組織のコミュニケーション構造に倣った構造を持つ設計を生み出す
- より良いマイクロサービスを生み出すには組織を含めたチームビルディングも重要になる

## チーム
- 各サービスはひとつのチームによって所有され、チームはそのサービスについての要件・設計・実装・テスト・運用のすべてに権限と責任を負う
- サービスごとの責任感がまし、自ら改善を行いやすくなる
- 社内オープンソースという考え方で、リソースの共有を下げることはできる
- 逆向きコンウェイの法則でシステム側からチームのあり方を定義するという発想もある

## 人
- メンバーのスキルを踏まえて、マイクロサービス化を戦略的に進める必要がある
- メンバーが、サービスを開発するチームの一員として負わなければならない責任とその理由を理解し、自律的な成長を促すことが重要

# 11章 大規模なマイクロサービス
- 障害はどんな場合にも起こると考え、落ちても復旧しやすい状態にしておくことが大切
- CAPの定理
    - 分散システムは整合性、可用性、分断体制のうち２つしか守れない

# 12章 まとめ
- サービスは、技術的観点ではなく、ビジネス的観点（DDDの境界づけられたコンテキスト）で分割する
- テスト、デプロイなどは積極的に自動化する
- サービスは内部実装の詳細を隠蔽し、特定の技術要素に依存しないAPIを公開する
- サービスはチームに所有させる
- サービスを単独で本番デプロイできるようにする
- システムの可用性を得るには、連鎖的障害が発生しないような設計・実装が必要になる
- CAP定理の 整合性 と 可用性 のどちらを犠牲にするのが適切かを検討する。
- セマンティック監視で、システム全体の状態を監視する。
- ドメインに対する理解度が低い場合は、いきなりマイクロサービス化せずにいったんモノリシックに作って、徐々にサービス化していく
- ビジネスや技術の進歩にあわせて、サービスを徐々に進化（書き直し）させていく

# 感想
## 面白いと感じた
  - オブジェクト指向(DDD)的な考え方が、クラウド等の発達によって現実世界側に染み出している感覚
  - 並行処理が書きやすいGo言語によって、各サービスを並行処理することでおしゃれプログラミングが実践できる点
  - アジャイル的な動きが加速しそうなところ
  - 自由度の高い開発ができそうな点
  - 各サービスに専門的な人間をつけることでより強力なサービス開発が実現できる点

## 難しいと感じた
  - 人的リソース、サーバーリソースが大きくなる点
  - DBの分割
  - http通信のオーバーヘッド
  - トランザクションが貼れないところ
  - ドメインの分割でのミスが命取りになるところ
